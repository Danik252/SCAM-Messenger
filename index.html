<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ğ¡ĞšĞĞœ Messenger</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        * { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .chat-bubble-sent { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .chat-bubble-received { background: #374151; }
        .emoji-picker { display: none; }
        .emoji-picker.active { display: grid; }
        .hidden { display: none !important; }
        .avatar-preview { width: 100px; height: 100px; object-fit: cover; }
        video { background: #000; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #6366f1; border-radius: 3px; }
        .pulse-ring { animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }
        .notification-badge { animation: bounce 1s infinite; }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen">
    <!-- Auth Screen -->
    <div id="authScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md shadow-2xl">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-500">Ğ¡ĞšĞĞœ</h1>
                <p class="text-gray-400 mt-2">Messenger</p>
            </div>
            
            <div id="loginForm">
                <h2 class="text-xl font-semibold text-white mb-6">Ğ’Ñ…Ğ¾Ğ´</h2>
                <input type="text" id="loginUsername" placeholder="Ğ˜Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ" class="w-full p-3 bg-gray-700 rounded-lg text-white mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="password" id="loginPassword" placeholder="ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ" class="w-full p-3 bg-gray-700 rounded-lg text-white mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button id="loginBtn" class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition">Ğ’Ğ¾Ğ¹Ñ‚Ğ¸</button>
                <p class="text-gray-400 text-center mt-4">ĞĞµÑ‚ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°? <span id="showRegisterBtn" class="text-indigo-400 cursor-pointer hover:underline">Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ</span></p>
            </div>
            
            <div id="registerForm" class="hidden">
                <h2 class="text-xl font-semibold text-white mb-6">Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ</h2>
                <input type="text" id="regUsername" placeholder="Ğ˜Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ" class="w-full p-3 bg-gray-700 rounded-lg text-white mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="password" id="regPassword" placeholder="ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ" class="w-full p-3 bg-gray-700 rounded-lg text-white mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="password" id="regPasswordConfirm" placeholder="ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ" class="w-full p-3 bg-gray-700 rounded-lg text-white mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button id="registerBtn" class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition">Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚</button>
                <p class="text-gray-400 text-center mt-4">Ğ£Ğ¶Ğµ ĞµÑÑ‚ÑŒ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚? <span id="showLoginBtn" class="text-indigo-400 cursor-pointer hover:underline">Ğ’Ğ¾Ğ¹Ñ‚Ğ¸</span></p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden h-screen flex flex-col">
        <!-- Header -->
        <header class="gradient-bg p-4 flex items-center justify-between shadow-lg">
            <div class="flex items-center gap-3">
                <h1 class="text-2xl font-bold text-white">Ğ¡ĞšĞĞœ</h1>
            </div>
            <div class="flex items-center gap-3">
                <div class="relative">
                    <input type="text" id="searchUser" placeholder="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ ID Ğ¸Ğ»Ğ¸ Ğ½Ğ¸ĞºÑƒ..." class="bg-white/20 text-white placeholder-white/70 px-4 py-2 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-white/50 w-48">
                    <button id="searchBtn" class="absolute right-2 top-1/2 -translate-y-1/2 text-white">ğŸ”</button>
                </div>
                <button id="profileBtn" class="bg-white/20 hover:bg-white/30 p-2 rounded-full transition">
                    <img id="headerAvatar" src="" class="w-8 h-8 rounded-full object-cover">
                </button>
                <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-full text-sm transition">Ğ’Ñ‹Ğ¹Ñ‚Ğ¸</button>
            </div>
        </header>

        <!-- Content -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Sidebar -->
            <aside class="w-80 bg-gray-800 flex flex-col">
                <div class="p-4 border-b border-gray-700">
                    <button id="globalChatBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-semibold transition flex items-center justify-center gap-2">
                        ğŸŒ ĞĞ±Ñ‰Ğ¸Ğ¹ Ñ‡Ğ°Ñ‚
                    </button>
                </div>
                <div class="p-4 border-b border-gray-700">
                    <h3 class="text-gray-400 text-sm font-medium mb-2">Ğ›Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ñ‡Ğ°Ñ‚Ñ‹</h3>
                </div>
                <div id="chatList" class="flex-1 overflow-y-auto">
                    <!-- Chat items will be here -->
                </div>
            </aside>

            <!-- Chat Area -->
            <main class="flex-1 flex flex-col bg-gray-900">
                <div id="noChatSelected" class="flex-1 flex items-center justify-center text-gray-500">
                    <div class="text-center">
                        <div class="text-6xl mb-4">ğŸ’¬</div>
                        <p>Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ‡Ğ°Ñ‚ Ğ¸Ğ»Ğ¸ Ğ½Ğ°Ñ‡Ğ½Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ€Ğ°Ğ·Ğ³Ğ¾Ğ²Ğ¾Ñ€</p>
                    </div>
                </div>

                <div id="chatArea" class="hidden flex-1 flex flex-col">
                    <!-- Chat Header -->
                    <div class="bg-gray-800 p-4 flex items-center justify-between border-b border-gray-700">
                        <div class="flex items-center gap-3">
                            <img id="chatAvatar" src="" class="w-10 h-10 rounded-full object-cover">
                            <div>
                                <h3 id="chatName" class="text-white font-semibold"></h3>
                                <p id="chatStatus" class="text-gray-400 text-sm">Ğ¾Ğ½Ğ»Ğ°Ğ¹Ğ½</p>
                            </div>
                        </div>
                        <div id="callButtons" class="flex gap-2">
                            <button id="voiceCallBtn" class="bg-green-600 hover:bg-green-700 text-white p-3 rounded-full transition" title="Ğ“Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ¾Ğ¹ Ğ·Ğ²Ğ¾Ğ½Ğ¾Ğº">ğŸ“</button>
                            <button id="videoCallBtn" class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full transition" title="Ğ’Ğ¸Ğ´ĞµĞ¾Ğ·Ğ²Ğ¾Ğ½Ğ¾Ğº">ğŸ“¹</button>
                        </div>
                    </div>

                    <!-- Messages -->
                    <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-4">
                        <!-- Messages will be here -->
                    </div>

                    <!-- Input -->
                    <div class="bg-gray-800 p-4 border-t border-gray-700">
                        <div class="relative">
                            <div id="emojiPicker" class="emoji-picker absolute bottom-full left-0 mb-2 bg-gray-700 rounded-lg p-3 grid-cols-8 gap-1 max-h-48 overflow-y-auto w-80">
                                <!-- Emojis will be here -->
                            </div>
                            <div class="flex gap-2">
                                <button id="emojiBtn" class="bg-gray-700 hover:bg-gray-600 text-2xl p-3 rounded-lg transition">ğŸ˜Š</button>
                                <input type="text" id="messageInput" placeholder="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ..." class="flex-1 bg-gray-700 text-white px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <button id="sendBtn" class="gradient-bg text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90 transition">ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-2xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white">ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ</h2>
                <button id="closeProfileBtn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="text-center mb-6">
                <div class="relative inline-block">
                    <img id="profileAvatar" src="" class="avatar-preview rounded-full mx-auto mb-4 border-4 border-indigo-500">
                    <label class="absolute bottom-4 right-0 bg-indigo-600 hover:bg-indigo-700 p-2 rounded-full cursor-pointer transition">
                        <span>ğŸ“·</span>
                        <input type="file" id="avatarFileInput" accept="image/*" class="hidden">
                    </label>
                </div>
                <p class="text-gray-400 text-sm">ID: <span id="profileId" class="text-indigo-400 font-mono"></span></p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-gray-400 text-sm">Ğ˜Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ</label>
                    <input type="text" id="profileUsername" class="w-full bg-gray-700 text-white p-3 rounded-lg mt-1 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="flex gap-2">
                    <input type="text" id="avatarUrl" placeholder="URL Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€ĞºĞ¸" class="flex-1 bg-gray-700 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button id="setAvatarUrlBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 rounded-lg transition">OK</button>
                </div>
                <button id="saveProfileBtn" class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
            </div>
        </div>
    </div>

    <!-- Search Results Modal -->
    <div id="searchModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-2xl p-6 w-full max-w-md max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white">Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ¿Ğ¾Ğ¸ÑĞºĞ°</h2>
                <button id="closeSearchBtn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="searchResults" class="space-y-2">
                <!-- Results will be here -->
            </div>
        </div>
    </div>

    <!-- Call Modal -->
    <div id="callModal" class="hidden fixed inset-0 bg-gray-900 flex flex-col z-50">
        <div class="flex-1 relative">
            <video id="remoteVideo" autoplay playsinline class="w-full h-full object-cover"></video>
            <video id="localVideo" autoplay playsinline muted class="absolute bottom-4 right-4 w-48 h-36 object-cover rounded-lg border-2 border-white shadow-lg"></video>
            <div id="callInfo" class="absolute top-4 left-4 bg-black/50 px-4 py-2 rounded-lg">
                <p class="text-white font-semibold" id="callPartnerName"></p>
                <p class="text-gray-300 text-sm" id="callDuration">00:00</p>
            </div>
        </div>
        <div class="bg-gray-800 p-6 flex justify-center gap-4">
            <button id="micBtn" class="bg-gray-600 hover:bg-gray-700 text-white p-4 rounded-full transition text-2xl" title="ĞœĞ¸ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½">ğŸ¤</button>
            <button id="cameraBtn" class="bg-gray-600 hover:bg-gray-700 text-white p-4 rounded-full transition text-2xl" title="ĞšĞ°Ğ¼ĞµÑ€Ğ°">ğŸ“¹</button>
            <button id="screenBtn" class="bg-gray-600 hover:bg-gray-700 text-white p-4 rounded-full transition text-2xl" title="Ğ”ĞµĞ¼Ğ¾Ğ½ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ ÑĞºÑ€Ğ°Ğ½Ğ°">ğŸ–¥ï¸</button>
            <button id="endCallBtn" class="bg-red-600 hover:bg-red-700 text-white p-4 rounded-full transition text-2xl" title="Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ">ğŸ“µ</button>
        </div>
    </div>

    <!-- Incoming Call Modal -->
    <div id="incomingCallModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-2xl p-8 text-center">
            <div class="relative inline-block mb-4">
                <div class="absolute inset-0 bg-green-500 rounded-full pulse-ring"></div>
                <img id="incomingCallerAvatar" src="" class="w-24 h-24 rounded-full relative z-10 border-4 border-green-500">
            </div>
            <h2 id="incomingCallerName" class="text-white text-xl font-bold mb-2"></h2>
            <p class="text-gray-400 mb-6" id="incomingCallType">Ğ’Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğ¹ Ğ·Ğ²Ğ¾Ğ½Ğ¾Ğº...</p>
            <div class="flex gap-4 justify-center">
                <button id="acceptCallBtn" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-full font-semibold transition">âœ“ ĞŸÑ€Ğ¸Ğ½ÑÑ‚ÑŒ</button>
                <button id="declineCallBtn" class="bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded-full font-semibold transition">âœ— ĞÑ‚ĞºĞ»Ğ¾Ğ½Ğ¸Ñ‚ÑŒ</button>
            </div>
        </div>
    </div>

    <script>
        // Emojis
        const emojis = ['ğŸ˜€','ğŸ˜ƒ','ğŸ˜„','ğŸ˜','ğŸ˜…','ğŸ˜‚','ğŸ¤£','ğŸ˜Š','ğŸ˜‡','ğŸ™‚','ğŸ˜‰','ğŸ˜Œ','ğŸ˜','ğŸ¥°','ğŸ˜˜','ğŸ˜—','ğŸ˜™','ğŸ˜š','ğŸ˜‹','ğŸ˜›','ğŸ˜œ','ğŸ¤ª','ğŸ˜','ğŸ¤‘','ğŸ¤—','ğŸ¤­','ğŸ¤«','ğŸ¤”','ğŸ¤','ğŸ¤¨','ğŸ˜','ğŸ˜‘','ğŸ˜¶','ğŸ˜','ğŸ˜’','ğŸ™„','ğŸ˜¬','ğŸ¤¥','ğŸ˜Œ','ğŸ˜”','ğŸ˜ª','ğŸ¤¤','ğŸ˜´','ğŸ˜·','ğŸ¤’','ğŸ¤•','ğŸ¤¢','ğŸ¤®','ğŸ¥µ','ğŸ¥¶','ğŸ¥´','ğŸ˜µ','ğŸ¤¯','ğŸ¤ ','ğŸ¥³','ğŸ˜','ğŸ¤“','ğŸ§','ğŸ˜•','ğŸ˜Ÿ','ğŸ™','â˜¹ï¸','ğŸ˜®','ğŸ˜¯','ğŸ˜²','ğŸ˜³','ğŸ¥º','ğŸ˜¦','ğŸ˜§','ğŸ˜¨','ğŸ˜°','ğŸ˜¥','ğŸ˜¢','ğŸ˜­','ğŸ˜±','ğŸ˜–','ğŸ˜£','ğŸ˜','ğŸ˜“','ğŸ˜©','ğŸ˜«','ğŸ¥±','ğŸ˜¤','ğŸ˜¡','ğŸ˜ ','ğŸ¤¬','ğŸ˜ˆ','ğŸ‘¿','ğŸ’€','â˜ ï¸','ğŸ’©','ğŸ¤¡','ğŸ‘¹','ğŸ‘º','ğŸ‘»','ğŸ‘½','ğŸ‘¾','ğŸ¤–','ğŸ˜º','ğŸ˜¸','ğŸ˜¹','ğŸ˜»','ğŸ˜¼','ğŸ˜½','ğŸ™€','ğŸ˜¿','ğŸ˜¾','â¤ï¸','ğŸ§¡','ğŸ’›','ğŸ’š','ğŸ’™','ğŸ’œ','ğŸ–¤','ğŸ¤','ğŸ¤','ğŸ’”','â£ï¸','ğŸ’•','ğŸ’','ğŸ’“','ğŸ’—','ğŸ’–','ğŸ’˜','ğŸ’','ğŸ’Ÿ','ğŸ‘','ğŸ‘','ğŸ‘Š','âœŠ','ğŸ¤›','ğŸ¤œ','ğŸ¤','âœŒï¸','ğŸ¤Ÿ','ğŸ¤˜','ğŸ‘Œ','ğŸ¤','ğŸ‘ˆ','ğŸ‘‰','ğŸ‘†','ğŸ‘‡','â˜ï¸','âœ‹','ğŸ¤š','ğŸ–ï¸','ğŸ––','ğŸ‘‹','ğŸ¤™','ğŸ’ª','ğŸ¦¾','ğŸ–•','âœï¸','ğŸ™','ğŸ¦¶','ğŸ¦µ','ğŸ¦¿','ğŸ’„','ğŸ’‹','ğŸ‘„','ğŸ¦·','ğŸ‘…','ğŸ‘‚','ğŸ¦»','ğŸ‘ƒ','ğŸ‘£','ğŸ‘ï¸','ğŸ‘€','ğŸ§ ','ğŸ—£ï¸','ğŸ‘¤','ğŸ‘¥','ğŸ«‚','ğŸ‘¶','ğŸ‘§','ğŸ§’','ğŸ‘¦','ğŸ‘©','ğŸ§‘','ğŸ‘¨','ğŸ‘±â€â™€ï¸','ğŸ‘±','ğŸ§”','ğŸ‘´','ğŸ‘µ','ğŸ§“','ğŸ‘²','ğŸ‘³â€â™€ï¸','ğŸ‘³','ğŸ§•','ğŸ‘®â€â™€ï¸','ğŸ‘®','ğŸ‘·â€â™€ï¸','ğŸ‘·','ğŸ’‚â€â™€ï¸','ğŸ’‚','ğŸ•µï¸â€â™€ï¸','ğŸ•µï¸','ğŸ‘©â€âš•ï¸','ğŸ‘¨â€âš•ï¸','ğŸ‘©â€ğŸŒ¾','ğŸ‘¨â€ğŸŒ¾','ğŸ‘©â€ğŸ³','ğŸ‘¨â€ğŸ³','ğŸ‘©â€ğŸ“','ğŸ‘¨â€ğŸ“','ğŸ‘©â€ğŸ¤','ğŸ‘¨â€ğŸ¤','ğŸ‘©â€ğŸ«','ğŸ‘¨â€ğŸ«','ğŸ‘©â€ğŸ­','ğŸ‘¨â€ğŸ­','ğŸ‘©â€ğŸ’»','ğŸ‘¨â€ğŸ’»','ğŸ‘©â€ğŸ’¼','ğŸ‘¨â€ğŸ’¼','ğŸ‘©â€ğŸ”§','ğŸ‘¨â€ğŸ”§','ğŸ‘©â€ğŸ”¬','ğŸ‘¨â€ğŸ”¬','ğŸ‘©â€ğŸ¨','ğŸ‘¨â€ğŸ¨','ğŸ‘©â€ğŸš’','ğŸ‘¨â€ğŸš’','ğŸ‘©â€âœˆï¸','ğŸ‘¨â€âœˆï¸','ğŸ‘©â€ğŸš€','ğŸ‘¨â€ğŸš€','ğŸ‘©â€âš–ï¸','ğŸ‘¨â€âš–ï¸','ğŸ‘°','ğŸ¤µ','ğŸ‘¸','ğŸ¤´','ğŸ¦¸â€â™€ï¸','ğŸ¦¸','ğŸ¦¹â€â™€ï¸','ğŸ¦¹','ğŸ¤¶','ğŸ…','ğŸ§™â€â™€ï¸','ğŸ§™','ğŸ§â€â™€ï¸','ğŸ§','ğŸ§›â€â™€ï¸','ğŸ§›','ğŸ§Ÿâ€â™€ï¸','ğŸ§Ÿ','ğŸ§â€â™€ï¸','ğŸ§','ğŸ§œâ€â™€ï¸','ğŸ§œ','ğŸ§šâ€â™€ï¸','ğŸ§š','ğŸ‘¼','ğŸ¤°','ğŸ¤±','ğŸ™‡â€â™€ï¸','ğŸ™‡','ğŸ’â€â™€ï¸','ğŸ’','ğŸ™…â€â™€ï¸','ğŸ™…','ğŸ™†â€â™€ï¸','ğŸ™†','ğŸ™‹â€â™€ï¸','ğŸ™‹','ğŸ§â€â™€ï¸','ğŸ§','ğŸ¤¦â€â™€ï¸','ğŸ¤¦','ğŸ¤·â€â™€ï¸','ğŸ¤·','ğŸ™â€â™€ï¸','ğŸ™','ğŸ™â€â™€ï¸','ğŸ™','ğŸ’‡â€â™€ï¸','ğŸ’‡','ğŸ’†â€â™€ï¸','ğŸ’†'];
        
        // State
        let currentUser = null;
        let currentChat = null;
        let isGlobalChat = false;
        let localStream = null;
        let screenStream = null;
        let callTimer = null;
        let callSeconds = 0;
        let micEnabled = true;
        let cameraEnabled = true;
        let screenEnabled = false;
        let incomingCallData = null;

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            initEmojis();
            initEventListeners();
            checkAuth();
            // Simulate real-time updates
            setInterval(checkForUpdates, 1000);
        });

        function initEventListeners() {
            // Auth buttons
            document.getElementById('loginBtn').addEventListener('click', login);
            document.getElementById('registerBtn').addEventListener('click', register);
            document.getElementById('showRegisterBtn').addEventListener('click', showRegister);
            document.getElementById('showLoginBtn').addEventListener('click', showLogin);
            
            // Main app buttons
            document.getElementById('searchBtn').addEventListener('click', searchUsers);
            document.getElementById('profileBtn').addEventListener('click', showProfile);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('globalChatBtn').addEventListener('click', openGlobalChat);
            
            // Chat buttons
            document.getElementById('emojiBtn').addEventListener('click', toggleEmoji);
            document.getElementById('sendBtn').addEventListener('click', sendMessage);
            document.getElementById('voiceCallBtn').addEventListener('click', function() { startCall(false); });
            document.getElementById('videoCallBtn').addEventListener('click', function() { startCall(true); });
            
            // Message input enter key
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendMessage();
            });
            
            // Profile modal
            document.getElementById('closeProfileBtn').addEventListener('click', closeProfile);
            document.getElementById('avatarFileInput').addEventListener('change', changeAvatar);
            document.getElementById('setAvatarUrlBtn').addEventListener('click', setAvatarUrl);
            document.getElementById('saveProfileBtn').addEventListener('click', saveProfile);
            
            // Search modal
            document.getElementById('closeSearchBtn').addEventListener('click', closeSearch);
            
            // Call controls
            document.getElementById('micBtn').addEventListener('click', toggleMic);
            document.getElementById('cameraBtn').addEventListener('click', toggleCamera);
            document.getElementById('screenBtn').addEventListener('click', toggleScreen);
            document.getElementById('endCallBtn').addEventListener('click', endCall);
            
            // Incoming call
            document.getElementById('acceptCallBtn').addEventListener('click', acceptCall);
            document.getElementById('declineCallBtn').addEventListener('click', declineCall);
            
            // Escape key to close modals
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeProfile();
                    closeSearch();
                }
            });
        }

        function initEmojis() {
            const picker = document.getElementById('emojiPicker');
            emojis.forEach(function(emoji) {
                const btn = document.createElement('button');
                btn.className = 'text-2xl hover:bg-gray-600 p-1 rounded transition';
                btn.textContent = emoji;
                btn.addEventListener('click', function() { insertEmoji(emoji); });
                picker.appendChild(btn);
            });
        }

        function insertEmoji(emoji) {
            const input = document.getElementById('messageInput');
            input.value += emoji;
            input.focus();
        }

        function toggleEmoji() {
            document.getElementById('emojiPicker').classList.toggle('active');
        }

        // Auth functions
        function getUsers() {
            try {
                return JSON.parse(localStorage.getItem('scam_users') || '{}');
            } catch(e) {
                return {};
            }
        }

        function saveUsers(users) {
            try {
                localStorage.setItem('scam_users', JSON.stringify(users));
            } catch(e) {
                alert('ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…!');
            }
        }

        function generateId() {
            return 'ID' + Math.random().toString(36).substr(2, 8).toUpperCase();
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function showLogin() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        function register() {
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value;
            const passwordConfirm = document.getElementById('regPasswordConfirm').value;

            if (!username || !password) {
                alert('Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ²ÑĞµ Ğ¿Ğ¾Ğ»Ñ!');
                return;
            }

            if (password !== passwordConfirm) {
                alert('ĞŸĞ°Ñ€Ğ¾Ğ»Ğ¸ Ğ½Ğµ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°ÑÑ‚!');
                return;
            }

            if (username.length < 2) {
                alert('Ğ˜Ğ¼Ñ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 2 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ°!');
                return;
            }

            if (password.length < 3) {
                alert('ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 3 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ°!');
                return;
            }

            const users = getUsers();
            const existingUser = Object.values(users).find(function(u) {
                return u.username.toLowerCase() === username.toLowerCase();
            });

            if (existingUser) {
                alert('ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ñ Ñ‚Ğ°ĞºĞ¸Ğ¼ Ğ¸Ğ¼ĞµĞ½ĞµĞ¼ ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚!');
                return;
            }

            const id = generateId();
            users[id] = {
                id: id,
                username: username,
                password: password,
                avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + encodeURIComponent(username),
                createdAt: Date.now()
            };

            saveUsers(users);
            alert('Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ°! Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ²Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ.');
            
            // Clear fields
            document.getElementById('regUsername').value = '';
            document.getElementById('regPassword').value = '';
            document.getElementById('regPasswordConfirm').value = '';
            
            showLogin();
        }

        function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                alert('Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ²ÑĞµ Ğ¿Ğ¾Ğ»Ñ!');
                return;
            }

            const users = getUsers();
            const user = Object.values(users).find(function(u) {
                return u.username.toLowerCase() === username.toLowerCase() && u.password === password;
            });

            if (!user) {
                alert('ĞĞµĞ²ĞµÑ€Ğ½Ğ¾Ğµ Ğ¸Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¸Ğ»Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ!');
                return;
            }

            currentUser = user;
            localStorage.setItem('scam_current_user', user.id);
            showApp();
        }

        function checkAuth() {
            const userId = localStorage.getItem('scam_current_user');
            if (userId) {
                const users = getUsers();
                if (users[userId]) {
                    currentUser = users[userId];
                    showApp();
                }
            }
        }

        function logout() {
            localStorage.removeItem('scam_current_user');
            currentUser = null;
            currentChat = null;
            isGlobalChat = false;
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('authScreen').classList.remove('hidden');
        }

        function showApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            updateHeader();
            loadChatList();
        }

        function updateHeader() {
            document.getElementById('headerAvatar').src = currentUser.avatar;
        }

        // Profile
        function showProfile() {
            document.getElementById('profileModal').classList.remove('hidden');
            document.getElementById('profileAvatar').src = currentUser.avatar;
            document.getElementById('profileId').textContent = currentUser.id;
            document.getElementById('profileUsername').value = currentUser.username;
        }

        function closeProfile() {
            document.getElementById('profileModal').classList.add('hidden');
        }

        function changeAvatar(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentUser.avatar = e.target.result;
                    document.getElementById('profileAvatar').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function setAvatarUrl() {
            const url = document.getElementById('avatarUrl').value.trim();
            if (url) {
                currentUser.avatar = url;
                document.getElementById('profileAvatar').src = url;
                document.getElementById('avatarUrl').value = '';
            }
        }

        function saveProfile() {
            const newUsername = document.getElementById('profileUsername').value.trim();
            if (!newUsername) {
                alert('Ğ˜Ğ¼Ñ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼!');
                return;
            }

            const users = getUsers();
            const existingUser = Object.values(users).find(function(u) {
                return u.username.toLowerCase() === newUsername.toLowerCase() && u.id !== currentUser.id;
            });

            if (existingUser) {
                alert('Ğ­Ñ‚Ğ¾ Ğ¸Ğ¼Ñ ÑƒĞ¶Ğµ Ğ·Ğ°Ğ½ÑÑ‚Ğ¾!');
                return;
            }

            currentUser.username = newUsername;
            users[currentUser.id] = currentUser;
            saveUsers(users);
            updateHeader();
            closeProfile();
            alert('ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½!');
        }

        // Search
        function searchUsers() {
            const query = document.getElementById('searchUser').value.trim().toLowerCase();
            if (!query) {
                alert('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¸Ğ¼Ñ Ğ¸Ğ»Ğ¸ ID Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ¸ÑĞºĞ°!');
                return;
            }

            const users = getUsers();
            const results = Object.values(users).filter(function(u) {
                // Exclude current user from search results
                if (u.id === currentUser.id) return false;
                return u.username.toLowerCase().includes(query) || u.id.toLowerCase().includes(query);
            });

            const container = document.getElementById('searchResults');
            container.innerHTML = '';

            if (results.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center">ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹</p>';
            } else {
                results.forEach(function(user) {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-3 p-3 bg-gray-700 rounded-lg hover:bg-gray-600 cursor-pointer transition';
                    div.innerHTML = '<img src="' + user.avatar + '" class="w-12 h-12 rounded-full object-cover">' +
                        '<div>' +
                        '<p class="text-white font-medium">' + user.username + '</p>' +
                        '<p class="text-gray-400 text-sm">' + user.id + '</p>' +
                        '</div>';
                    div.addEventListener('click', function() {
                        closeSearch();
                        openPrivateChat(user.id);
                    });
                    container.appendChild(div);
                });
            }

            document.getElementById('searchModal').classList.remove('hidden');
        }

        function closeSearch() {
            document.getElementById('searchModal').classList.add('hidden');
            document.getElementById('searchUser').value = '';
        }

        // Messages
        function getMessages() {
            try {
                return JSON.parse(localStorage.getItem('scam_messages') || '{}');
            } catch(e) {
                return {};
            }
        }

        function saveMessages(messages) {
            try {
                localStorage.setItem('scam_messages', JSON.stringify(messages));
            } catch(e) {
                console.error('Error saving messages');
            }
        }

        function getChatKey(userId1, userId2) {
            return [userId1, userId2].sort().join('_');
        }

        function loadChatList() {
            const messages = getMessages();
            const users = getUsers();
            const chatList = document.getElementById('chatList');
            chatList.innerHTML = '';

            const chats = new Set();
            Object.keys(messages).forEach(function(key) {
                if (key !== 'global' && key.includes(currentUser.id)) {
                    const parts = key.split('_');
                    const otherUserId = parts.find(function(id) { return id !== currentUser.id; });
                    if (otherUserId && users[otherUserId]) {
                        chats.add(otherUserId);
                    }
                }
            });

            chats.forEach(function(userId) {
                const user = users[userId];
                if (user) {
                    const chatKey = getChatKey(currentUser.id, userId);
                    const chatMessages = messages[chatKey] || [];
                    const lastMessage = chatMessages[chatMessages.length - 1];

                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-3 p-4 hover:bg-gray-700 cursor-pointer transition border-b border-gray-700';
                    div.innerHTML = '<img src="' + user.avatar + '" class="w-12 h-12 rounded-full object-cover">' +
                        '<div class="flex-1 min-w-0">' +
                        '<p class="text-white font-medium truncate">' + user.username + '</p>' +
                        '<p class="text-gray-400 text-sm truncate">' + (lastMessage ? lastMessage.text : 'ĞĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹') + '</p>' +
                        '</div>';
                    div.addEventListener('click', function() { openPrivateChat(userId); });
                    chatList.appendChild(div);
                }
            });
        }

        function openGlobalChat() {
            isGlobalChat = true;
            currentChat = null;
            document.getElementById('noChatSelected').classList.add('hidden');
            document.getElementById('chatArea').classList.remove('hidden');
            document.getElementById('chatName').textContent = 'ğŸŒ ĞĞ±Ñ‰Ğ¸Ğ¹ Ñ‡Ğ°Ñ‚';
            document.getElementById('chatAvatar').src = 'https://api.dicebear.com/7.x/identicon/svg?seed=global';
            document.getElementById('chatStatus').textContent = 'Ğ’ÑĞµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸';
            
            // Hide call buttons for global chat
            document.getElementById('callButtons').classList.add('hidden');
            
            loadMessages();
        }

        function openPrivateChat(userId) {
            // Don't allow chatting with yourself
            if (userId === currentUser.id) {
                alert('ĞĞµĞ»ÑŒĞ·Ñ Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ ÑĞ°Ğ¼Ğ¾Ğ¼Ñƒ ÑĞµĞ±Ğµ!');
                return;
            }

            const users = getUsers();
            const user = users[userId];
            if (!user) return;

            isGlobalChat = false;
            currentChat = userId;
            document.getElementById('noChatSelected').classList.add('hidden');
            document.getElementById('chatArea').classList.remove('hidden');
            document.getElementById('chatName').textContent = user.username;
            document.getElementById('chatAvatar').src = user.avatar;
            document.getElementById('chatStatus').textContent = 'Ğ’ ÑĞµÑ‚Ğ¸';
            
            // Show call buttons for private chat
            document.getElementById('callButtons').classList.remove('hidden');
            
            loadMessages();
            loadChatList();
        }

        function loadMessages() {
            const messages = getMessages();
            const users = getUsers();
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';

            let chatMessages = [];
            if (isGlobalChat) {
                chatMessages = messages['global'] || [];
            } else if (currentChat) {
                const chatKey = getChatKey(currentUser.id, currentChat);
                chatMessages = messages[chatKey] || [];
            }

            chatMessages.forEach(function(msg) {
                const isMine = msg.senderId === currentUser.id;
                const sender = users[msg.senderId] || { username: 'Ğ£Ğ´Ğ°Ğ»Ñ‘Ğ½Ğ½Ñ‹Ğ¹', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=deleted' };
                
                const div = document.createElement('div');
                div.className = 'flex ' + (isMine ? 'justify-end' : 'justify-start');
                
                const bubbleClass = isMine ? 'chat-bubble-sent' : 'chat-bubble-received';
                
                const avatarHtml = '<img src="' + sender.avatar + '" class="w-8 h-8 rounded-full object-cover cursor-pointer" data-userid="' + msg.senderId + '">';
                
                let nameHtml = '';
                if (isGlobalChat || !isMine) {
                    nameHtml = '<p class="text-indigo-300 text-xs font-medium mb-1 cursor-pointer" data-userid="' + msg.senderId + '">' + sender.username + '</p>';
                }
                
                const timeStr = new Date(msg.timestamp).toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
                
                div.innerHTML = '<div class="flex ' + (isMine ? 'flex-row-reverse' : '') + ' items-end gap-2 max-w-[70%]">' +
                    avatarHtml +
                    '<div class="' + bubbleClass + ' px-4 py-2 rounded-2xl">' +
                    nameHtml +
                    '<p class="text-white break-words">' + escapeHtml(msg.text) + '</p>' +
                    '<p class="text-gray-300 text-xs mt-1 text-right">' + timeStr + '</p>' +
                    '</div></div>';
                
                // Add click handlers for opening private chat
                const clickableElements = div.querySelectorAll('[data-userid]');
                clickableElements.forEach(function(el) {
                    el.addEventListener('click', function() {
                        const uid = el.getAttribute('data-userid');
                        if (uid !== currentUser.id) {
                            openPrivateChat(uid);
                        }
                    });
                });
                
                container.appendChild(div);
            });

            container.scrollTop = container.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text) return;

            const messages = getMessages();
            const message = {
                id: Date.now(),
                senderId: currentUser.id,
                text: text,
                timestamp: Date.now()
            };

            if (isGlobalChat) {
                if (!messages['global']) messages['global'] = [];
                messages['global'].push(message);
            } else if (currentChat) {
                const chatKey = getChatKey(currentUser.id, currentChat);
                if (!messages[chatKey]) messages[chatKey] = [];
                messages[chatKey].push(message);
            }

            saveMessages(messages);
            input.value = '';
            document.getElementById('emojiPicker').classList.remove('active');
            loadMessages();
            loadChatList();
        }

        function checkForUpdates() {
            if (isGlobalChat || currentChat) {
                loadMessages();
            }
            loadChatList();
            checkIncomingCalls();
        }

        // Calls
        function getCalls() {
            try {
                return JSON.parse(localStorage.getItem('scam_calls') || '{}');
            } catch(e) {
                return {};
            }
        }

        function saveCalls(calls) {
            try {
                localStorage.setItem('scam_calls', JSON.stringify(calls));
            } catch(e) {}
        }

        async function startCall(isVideo) {
            if (!currentChat || isGlobalChat) {
                alert('Ğ—Ğ²Ğ¾Ğ½ĞºĞ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ² Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ñ‡Ğ°Ñ‚Ğ°Ñ…!');
                return;
            }

            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: isVideo,
                    audio: true
                });

                const calls = getCalls();
                calls[currentChat] = {
                    from: currentUser.id,
                    to: currentChat,
                    isVideo: isVideo,
                    timestamp: Date.now(),
                    status: 'calling'
                };
                saveCalls(calls);

                document.getElementById('localVideo').srcObject = localStream;
                
                const users = getUsers();
                const partner = users[currentChat];
                document.getElementById('callPartnerName').textContent = partner.username;
                
                document.getElementById('callModal').classList.remove('hidden');
                startCallTimer();
                
                micEnabled = true;
                cameraEnabled = isVideo;
                updateCallButtons();

            } catch (err) {
                alert('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº ĞºĞ°Ğ¼ĞµÑ€Ğµ/Ğ¼Ğ¸ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½Ñƒ: ' + err.message);
            }
        }

        function checkIncomingCalls() {
            const calls = getCalls();
            const incomingCall = Object.values(calls).find(function(c) {
                return c.to === currentUser.id && c.status === 'calling' && Date.now() - c.timestamp < 30000;
            });

            if (incomingCall && !incomingCallData) {
                incomingCallData = incomingCall;
                const users = getUsers();
                const caller = users[incomingCall.from];
                
                if (caller) {
                    document.getElementById('incomingCallerAvatar').src = caller.avatar;
                    document.getElementById('incomingCallerName').textContent = caller.username;
                    document.getElementById('incomingCallType').textContent = incomingCall.isVideo ? 'Ğ’Ğ¸Ğ´ĞµĞ¾Ğ·Ğ²Ğ¾Ğ½Ğ¾Ğº...' : 'Ğ“Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ¾Ğ¹ Ğ·Ğ²Ğ¾Ğ½Ğ¾Ğº...';
                    document.getElementById('incomingCallModal').classList.remove('hidden');
                    
                    // Play sound
                    try {
                        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2telegs5o+LYlFcAADCi49WPUAAOLaXm1otN');
                        audio.loop = true;
                        audio.play().catch(function() {});
                        window.callRingtone = audio;
                    } catch(e) {}
                }
            }
        }

        async function acceptCall() {
            if (!incomingCallData) return;

            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: incomingCallData.isVideo,
                    audio: true
                });

                document.getElementById('localVideo').srcObject = localStream;
                
                const users = getUsers();
                const partner = users[incomingCallData.from];
                document.getElementById('callPartnerName').textContent = partner.username;
                
                const calls = getCalls();
                if (calls[currentUser.id]) {
                    calls[currentUser.id].status = 'accepted';
                    saveCalls(calls);
                }

                document.getElementById('incomingCallModal').classList.add('hidden');
                document.getElementById('callModal').classList.remove('hidden');
                
                if (window.callRingtone) {
                    window.callRingtone.pause();
                    window.callRingtone = null;
                }
                
                startCallTimer();
                micEnabled = true;
                cameraEnabled = incomingCallData.isVideo;
                updateCallButtons();
                
                currentChat = incomingCallData.from;
                isGlobalChat = false;
                incomingCallData = null;

            } catch (err) {
                alert('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº ĞºĞ°Ğ¼ĞµÑ€Ğµ/Ğ¼Ğ¸ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½Ñƒ: ' + err.message);
                declineCall();
            }
        }

        function declineCall() {
            if (window.callRingtone) {
                window.callRingtone.pause();
                window.callRingtone = null;
            }
            
            const calls = getCalls();
            if (incomingCallData && calls[currentUser.id]) {
                calls[currentUser.id].status = 'declined';
                saveCalls(calls);
            }
            
            document.getElementById('incomingCallModal').classList.add('hidden');
            incomingCallData = null;
        }

        function startCallTimer() {
            callSeconds = 0;
            if (callTimer) clearInterval(callTimer);
            callTimer = setInterval(function() {
                callSeconds++;
                const mins = Math.floor(callSeconds / 60).toString().padStart(2, '0');
                const secs = (callSeconds % 60).toString().padStart(2, '0');
                document.getElementById('callDuration').textContent = mins + ':' + secs;
            }, 1000);
        }

        function endCall() {
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(function(track) { track.stop(); });
                localStream = null;
            }
            if (screenStream) {
                screenStream.getTracks().forEach(function(track) { track.stop(); });
                screenStream = null;
            }
            
            const calls = getCalls();
            if (currentChat && calls[currentChat]) {
                delete calls[currentChat];
                saveCalls(calls);
            }
            
            document.getElementById('callModal').classList.add('hidden');
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('remoteVideo').srcObject = null;
        }

        function toggleMic() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    micEnabled = !micEnabled;
                    audioTrack.enabled = micEnabled;
                    updateCallButtons();
                }
            }
        }

        function toggleCamera() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    cameraEnabled = !cameraEnabled;
                    videoTrack.enabled = cameraEnabled;
                    updateCallButtons();
                }
            }
        }

        async function toggleScreen() {
            try {
                if (screenEnabled) {
                    if (screenStream) {
                        screenStream.getTracks().forEach(function(track) { track.stop(); });
                        screenStream = null;
                    }
                    document.getElementById('localVideo').srcObject = localStream;
                    screenEnabled = false;
                } else {
                    screenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: true,
                        audio: true
                    });
                    document.getElementById('localVideo').srcObject = screenStream;
                    screenEnabled = true;
                    
                    screenStream.getVideoTracks()[0].onended = function() {
                        document.getElementById('localVideo').srcObject = localStream;
                        screenEnabled = false;
                        updateCallButtons();
                    };
                }
                updateCallButtons();
            } catch (err) {
                console.log('Screen share cancelled');
            }
        }

        function updateCallButtons() {
            const micClass = micEnabled ? 'bg-gray-600 hover:bg-gray-700' : 'bg-red-600 hover:bg-red-700';
            const camClass = cameraEnabled ? 'bg-gray-600 hover:bg-gray-700' : 'bg-red-600 hover:bg-red-700';
            const screenClass = screenEnabled ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-600 hover:bg-gray-700';
            
            document.getElementById('micBtn').className = micClass + ' text-white p-4 rounded-full transition text-2xl';
            document.getElementById('cameraBtn').className = camClass + ' text-white p-4 rounded-full transition text-2xl';
            document.getElementById('screenBtn').className = screenClass + ' text-white p-4 rounded-full transition text-2xl';
        }
    </script>
</body>
</html>
