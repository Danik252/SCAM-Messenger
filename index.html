<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–ö–ê–ú Messenger</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        * { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .chat-bubble-sent { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .chat-bubble-received { background: #374151; }
        .emoji-picker { display: none; }
        .emoji-picker.active { display: grid; }
        .hidden { display: none !important; }
        .avatar-preview { width: 100px; height: 100px; object-fit: cover; }
        video { background: #000; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #6366f1; border-radius: 3px; }
        .pulse-ring { animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }
        .notification-badge { animation: bounce 1s infinite; }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen">
    <!-- Auth Screen -->
    <div id="authScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md shadow-2xl">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-500">–°–ö–ê–ú</h1>
                <p class="text-gray-400 mt-2">Messenger</p>
            </div>
            
            <div id="loginForm">
                <h2 class="text-xl font-semibold text-white mb-6">–í—Ö–æ–¥</h2>
                <input type="text" id="loginUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" class="w-full p-3 bg-gray-700 rounded-lg text-white mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full p-3 bg-gray-700 rounded-lg text-white mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button onclick="login()" class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition">–í–æ–π—Ç–∏</button>
                <p class="text-gray-400 text-center mt-4">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <span onclick="showRegister()" class="text-indigo-400 cursor-pointer hover:underline">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span></p>
            </div>
            
            <div id="registerForm" class="hidden">
                <h2 class="text-xl font-semibold text-white mb-6">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                <input type="text" id="regUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" class="w-full p-3 bg-gray-700 rounded-lg text-white mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="password" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full p-3 bg-gray-700 rounded-lg text-white mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="password" id="regPasswordConfirm" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" class="w-full p-3 bg-gray-700 rounded-lg text-white mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button onclick="register()" class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                <p class="text-gray-400 text-center mt-4">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <span onclick="showLogin()" class="text-indigo-400 cursor-pointer hover:underline">–í–æ–π—Ç–∏</span></p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden h-screen flex flex-col">
        <!-- Header -->
        <header class="gradient-bg p-4 flex items-center justify-between shadow-lg">
            <div class="flex items-center gap-3">
                <h1 class="text-2xl font-bold text-white">–°–ö–ê–ú</h1>
            </div>
            <div class="flex items-center gap-3">
                <div class="relative">
                    <input type="text" id="searchUser" placeholder="–ü–æ–∏—Å–∫ –ø–æ ID –∏–ª–∏ –Ω–∏–∫—É..." class="bg-white/20 text-white placeholder-white/70 px-4 py-2 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-white/50 w-48">
                    <button onclick="searchUsers()" class="absolute right-2 top-1/2 -translate-y-1/2 text-white">üîç</button>
                </div>
                <button onclick="showProfile()" class="bg-white/20 hover:bg-white/30 p-2 rounded-full transition">
                    <img id="headerAvatar" src="" class="w-8 h-8 rounded-full object-cover">
                </button>
                <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-full text-sm transition">–í—ã–π—Ç–∏</button>
            </div>
        </header>

        <!-- Content -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Sidebar -->
            <aside class="w-80 bg-gray-800 flex flex-col">
                <div class="p-4 border-b border-gray-700">
                    <button onclick="openGlobalChat()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-semibold transition flex items-center justify-center gap-2">
                        üåç –û–±—â–∏–π —á–∞—Ç
                    </button>
                </div>
                <div class="p-4 border-b border-gray-700">
                    <h3 class="text-gray-400 text-sm font-medium mb-2">–õ–∏—á–Ω—ã–µ —á–∞—Ç—ã</h3>
                </div>
                <div id="chatList" class="flex-1 overflow-y-auto">
                    <!-- Chat items will be here -->
                </div>
            </aside>

            <!-- Chat Area -->
            <main class="flex-1 flex flex-col bg-gray-900">
                <div id="noChatSelected" class="flex-1 flex items-center justify-center text-gray-500">
                    <div class="text-center">
                        <div class="text-6xl mb-4">üí¨</div>
                        <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–ª–∏ –Ω–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä</p>
                    </div>
                </div>

                <div id="chatArea" class="hidden flex-1 flex flex-col">
                    <!-- Chat Header -->
                    <div class="bg-gray-800 p-4 flex items-center justify-between border-b border-gray-700">
                        <div class="flex items-center gap-3">
                            <img id="chatAvatar" src="" class="w-10 h-10 rounded-full object-cover">
                            <div>
                                <h3 id="chatName" class="text-white font-semibold"></h3>
                                <p id="chatStatus" class="text-gray-400 text-sm">–æ–Ω–ª–∞–π–Ω</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="startCall(false)" class="bg-green-600 hover:bg-green-700 text-white p-3 rounded-full transition" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –∑–≤–æ–Ω–æ–∫">üìû</button>
                            <button onclick="startCall(true)" class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full transition" title="–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫">üìπ</button>
                        </div>
                    </div>

                    <!-- Messages -->
                    <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-4">
                        <!-- Messages will be here -->
                    </div>

                    <!-- Input -->
                    <div class="bg-gray-800 p-4 border-t border-gray-700">
                        <div class="relative">
                            <div id="emojiPicker" class="emoji-picker absolute bottom-full left-0 mb-2 bg-gray-700 rounded-lg p-3 grid-cols-8 gap-1 max-h-48 overflow-y-auto w-80">
                                <!-- Emojis will be here -->
                            </div>
                            <div class="flex gap-2">
                                <button onclick="toggleEmoji()" class="bg-gray-700 hover:bg-gray-600 text-2xl p-3 rounded-lg transition">üòä</button>
                                <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." class="flex-1 bg-gray-700 text-white px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" onkeypress="if(event.key==='Enter')sendMessage()">
                                <button onclick="sendMessage()" class="gradient-bg text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90 transition">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-2xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white">–ü—Ä–æ—Ñ–∏–ª—å</h2>
                <button onclick="closeProfile()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="text-center mb-6">
                <div class="relative inline-block">
                    <img id="profileAvatar" src="" class="avatar-preview rounded-full mx-auto mb-4 border-4 border-indigo-500">
                    <label class="absolute bottom-4 right-0 bg-indigo-600 hover:bg-indigo-700 p-2 rounded-full cursor-pointer transition">
                        <span>üì∑</span>
                        <input type="file" accept="image/*" onchange="changeAvatar(event)" class="hidden">
                    </label>
                </div>
                <p class="text-gray-400 text-sm">ID: <span id="profileId" class="text-indigo-400 font-mono"></span></p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-gray-400 text-sm">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                    <input type="text" id="profileUsername" class="w-full bg-gray-700 text-white p-3 rounded-lg mt-1 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="flex gap-2">
                    <input type="text" id="avatarUrl" placeholder="URL –∞–≤–∞—Ç–∞—Ä–∫–∏" class="flex-1 bg-gray-700 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button onclick="setAvatarUrl()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 rounded-lg transition">OK</button>
                </div>
                <button onclick="saveProfile()" class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Search Results Modal -->
    <div id="searchModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-2xl p-6 w-full max-w-md max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</h2>
                <button onclick="closeSearch()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="searchResults" class="space-y-2">
                <!-- Results will be here -->
            </div>
        </div>
    </div>

    <!-- Call Modal -->
    <div id="callModal" class="hidden fixed inset-0 bg-gray-900 flex flex-col z-50">
        <div class="flex-1 relative">
            <video id="remoteVideo" autoplay playsinline class="w-full h-full object-cover"></video>
            <video id="localVideo" autoplay playsinline muted class="absolute bottom-4 right-4 w-48 h-36 object-cover rounded-lg border-2 border-white shadow-lg"></video>
            <div id="callInfo" class="absolute top-4 left-4 bg-black/50 px-4 py-2 rounded-lg">
                <p class="text-white font-semibold" id="callPartnerName"></p>
                <p class="text-gray-300 text-sm" id="callDuration">00:00</p>
            </div>
        </div>
        <div class="bg-gray-800 p-6 flex justify-center gap-4">
            <button onclick="toggleMic()" id="micBtn" class="bg-gray-600 hover:bg-gray-700 text-white p-4 rounded-full transition text-2xl" title="–ú–∏–∫—Ä–æ—Ñ–æ–Ω">üé§</button>
            <button onclick="toggleCamera()" id="cameraBtn" class="bg-gray-600 hover:bg-gray-700 text-white p-4 rounded-full transition text-2xl" title="–ö–∞–º–µ—Ä–∞">üìπ</button>
            <button onclick="toggleScreen()" id="screenBtn" class="bg-gray-600 hover:bg-gray-700 text-white p-4 rounded-full transition text-2xl" title="–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞">üñ•Ô∏è</button>
            <button onclick="endCall()" class="bg-red-600 hover:bg-red-700 text-white p-4 rounded-full transition text-2xl" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å">üìµ</button>
        </div>
    </div>

    <!-- Incoming Call Modal -->
    <div id="incomingCallModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-2xl p-8 text-center">
            <div class="relative inline-block mb-4">
                <div class="absolute inset-0 bg-green-500 rounded-full pulse-ring"></div>
                <img id="incomingCallerAvatar" src="" class="w-24 h-24 rounded-full relative z-10 border-4 border-green-500">
            </div>
            <h2 id="incomingCallerName" class="text-white text-xl font-bold mb-2"></h2>
            <p class="text-gray-400 mb-6" id="incomingCallType">–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫...</p>
            <div class="flex gap-4 justify-center">
                <button onclick="acceptCall()" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-full font-semibold transition">‚úì –ü—Ä–∏–Ω—è—Ç—å</button>
                <button onclick="declineCall()" class="bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded-full font-semibold transition">‚úó –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // Emojis
        const emojis = ['üòÄ','üòÉ','üòÑ','üòÅ','üòÖ','üòÇ','ü§£','üòä','üòá','üôÇ','üòâ','üòå','üòç','ü•∞','üòò','üòó','üòô','üòö','üòã','üòõ','üòú','ü§™','üòù','ü§ë','ü§ó','ü§≠','ü§´','ü§î','ü§ê','ü§®','üòê','üòë','üò∂','üòè','üòí','üôÑ','üò¨','ü§•','üòå','üòî','üò™','ü§§','üò¥','üò∑','ü§í','ü§ï','ü§¢','ü§Æ','ü•µ','ü•∂','ü•¥','üòµ','ü§Ø','ü§†','ü•≥','üòé','ü§ì','üßê','üòï','üòü','üôÅ','‚òπÔ∏è','üòÆ','üòØ','üò≤','üò≥','ü•∫','üò¶','üòß','üò®','üò∞','üò•','üò¢','üò≠','üò±','üòñ','üò£','üòû','üòì','üò©','üò´','ü•±','üò§','üò°','üò†','ü§¨','üòà','üëø','üíÄ','‚ò†Ô∏è','üí©','ü§°','üëπ','üë∫','üëª','üëΩ','üëæ','ü§ñ','üò∫','üò∏','üòπ','üòª','üòº','üòΩ','üôÄ','üòø','üòæ','‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','ü§é','üíî','‚ù£Ô∏è','üíï','üíû','üíì','üíó','üíñ','üíò','üíù','üíü','üëç','üëé','üëä','‚úä','ü§õ','ü§ú','ü§û','‚úåÔ∏è','ü§ü','ü§ò','üëå','ü§è','üëà','üëâ','üëÜ','üëá','‚òùÔ∏è','‚úã','ü§ö','üñêÔ∏è','üññ','üëã','ü§ô','üí™','ü¶æ','üñï','‚úçÔ∏è','üôè','ü¶∂','ü¶µ','ü¶ø','üíÑ','üíã','üëÑ','ü¶∑','üëÖ','üëÇ','ü¶ª','üëÉ','üë£','üëÅÔ∏è','üëÄ','üß†','üó£Ô∏è','üë§','üë•','ü´Ç','üë∂','üëß','üßí','üë¶','üë©','üßë','üë®','üë±‚Äç‚ôÄÔ∏è','üë±','üßî','üë¥','üëµ','üßì','üë≤','üë≥‚Äç‚ôÄÔ∏è','üë≥','üßï','üëÆ‚Äç‚ôÄÔ∏è','üëÆ','üë∑‚Äç‚ôÄÔ∏è','üë∑','üíÇ‚Äç‚ôÄÔ∏è','üíÇ','üïµÔ∏è‚Äç‚ôÄÔ∏è','üïµÔ∏è','üë©‚Äç‚öïÔ∏è','üë®‚Äç‚öïÔ∏è','üë©‚Äçüåæ','üë®‚Äçüåæ','üë©‚Äçüç≥','üë®‚Äçüç≥','üë©‚Äçüéì','üë®‚Äçüéì','üë©‚Äçüé§','üë®‚Äçüé§','üë©‚Äçüè´','üë®‚Äçüè´','üë©‚Äçüè≠','üë®‚Äçüè≠','üë©‚Äçüíª','üë®‚Äçüíª','üë©‚Äçüíº','üë®‚Äçüíº','üë©‚Äçüîß','üë®‚Äçüîß','üë©‚Äçüî¨','üë®‚Äçüî¨','üë©‚Äçüé®','üë®‚Äçüé®','üë©‚Äçüöí','üë®‚Äçüöí','üë©‚Äç‚úàÔ∏è','üë®‚Äç‚úàÔ∏è','üë©‚ÄçüöÄ','üë®‚ÄçüöÄ','üë©‚Äç‚öñÔ∏è','üë®‚Äç‚öñÔ∏è','üë∞','ü§µ','üë∏','ü§¥','ü¶∏‚Äç‚ôÄÔ∏è','ü¶∏','ü¶π‚Äç‚ôÄÔ∏è','ü¶π','ü§∂','üéÖ','üßô‚Äç‚ôÄÔ∏è','üßô','üßù‚Äç‚ôÄÔ∏è','üßù','üßõ‚Äç‚ôÄÔ∏è','üßõ','üßü‚Äç‚ôÄÔ∏è','üßü','üßû‚Äç‚ôÄÔ∏è','üßû','üßú‚Äç‚ôÄÔ∏è','üßú','üßö‚Äç‚ôÄÔ∏è','üßö','üëº','ü§∞','ü§±','üôá‚Äç‚ôÄÔ∏è','üôá','üíÅ‚Äç‚ôÄÔ∏è','üíÅ','üôÖ‚Äç‚ôÄÔ∏è','üôÖ','üôÜ‚Äç‚ôÄÔ∏è','üôÜ','üôã‚Äç‚ôÄÔ∏è','üôã','üßè‚Äç‚ôÄÔ∏è','üßè','ü§¶‚Äç‚ôÄÔ∏è','ü§¶','ü§∑‚Äç‚ôÄÔ∏è','ü§∑','üôé‚Äç‚ôÄÔ∏è','üôé','üôç‚Äç‚ôÄÔ∏è','üôç','üíá‚Äç‚ôÄÔ∏è','üíá','üíÜ‚Äç‚ôÄÔ∏è','üíÜ'];
        
        // State
        let currentUser = null;
        let currentChat = null;
        let isGlobalChat = false;
        let localStream = null;
        let screenStream = null;
        let callTimer = null;
        let callSeconds = 0;
        let micEnabled = true;
        let cameraEnabled = true;
        let screenEnabled = false;
        let incomingCallData = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initEmojis();
            checkAuth();
            // Simulate real-time updates
            setInterval(checkForUpdates, 1000);
        });

        function initEmojis() {
            const picker = document.getElementById('emojiPicker');
            emojis.forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = 'text-2xl hover:bg-gray-600 p-1 rounded transition';
                btn.textContent = emoji;
                btn.onclick = () => insertEmoji(emoji);
                picker.appendChild(btn);
            });
        }

        function insertEmoji(emoji) {
            const input = document.getElementById('messageInput');
            input.value += emoji;
            input.focus();
        }

        function toggleEmoji() {
            document.getElementById('emojiPicker').classList.toggle('active');
        }

        // Auth functions
        function getUsers() {
            return JSON.parse(localStorage.getItem('scam_users') || '{}');
        }

        function saveUsers(users) {
            localStorage.setItem('scam_users', JSON.stringify(users));
        }

        function generateId() {
            return 'ID' + Math.random().toString(36).substr(2, 8).toUpperCase();
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function showLogin() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        function register() {
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value;
            const passwordConfirm = document.getElementById('regPasswordConfirm').value;

            if (!username || !password) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
                return;
            }

            if (password !== passwordConfirm) {
                alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!');
                return;
            }

            const users = getUsers();
            if (Object.values(users).some(u => u.username.toLowerCase() === username.toLowerCase())) {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
                return;
            }

            const id = generateId();
            users[id] = {
                id,
                username,
                password,
                avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${username}`,
                createdAt: Date.now()
            };

            saveUsers(users);
            alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.');
            showLogin();
        }

        function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            const users = getUsers();
            const user = Object.values(users).find(u => 
                u.username.toLowerCase() === username.toLowerCase() && u.password === password
            );

            if (!user) {
                alert('–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å!');
                return;
            }

            currentUser = user;
            localStorage.setItem('scam_current_user', user.id);
            showApp();
        }

        function checkAuth() {
            const userId = localStorage.getItem('scam_current_user');
            if (userId) {
                const users = getUsers();
                if (users[userId]) {
                    currentUser = users[userId];
                    showApp();
                }
            }
        }

        function logout() {
            localStorage.removeItem('scam_current_user');
            currentUser = null;
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('authScreen').classList.remove('hidden');
        }

        function showApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            updateHeader();
            loadChatList();
        }

        function updateHeader() {
            document.getElementById('headerAvatar').src = currentUser.avatar;
        }

        // Profile
        function showProfile() {
            document.getElementById('profileModal').classList.remove('hidden');
            document.getElementById('profileAvatar').src = currentUser.avatar;
            document.getElementById('profileId').textContent = currentUser.id;
            document.getElementById('profileUsername').value = currentUser.username;
        }

        function closeProfile() {
            document.getElementById('profileModal').classList.add('hidden');
        }

        function changeAvatar(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentUser.avatar = e.target.result;
                    document.getElementById('profileAvatar').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function setAvatarUrl() {
            const url = document.getElementById('avatarUrl').value.trim();
            if (url) {
                currentUser.avatar = url;
                document.getElementById('profileAvatar').src = url;
                document.getElementById('avatarUrl').value = '';
            }
        }

        function saveProfile() {
            const newUsername = document.getElementById('profileUsername').value.trim();
            if (!newUsername) {
                alert('–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!');
                return;
            }

            const users = getUsers();
            const existingUser = Object.values(users).find(u => 
                u.username.toLowerCase() === newUsername.toLowerCase() && u.id !== currentUser.id
            );

            if (existingUser) {
                alert('–≠—Ç–æ –∏–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ!');
                return;
            }

            currentUser.username = newUsername;
            users[currentUser.id] = currentUser;
            saveUsers(users);
            updateHeader();
            closeProfile();
            alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
        }

        // Search
        function searchUsers() {
            const query = document.getElementById('searchUser').value.trim().toLowerCase();
            if (!query) return;

            const users = getUsers();
            const results = Object.values(users).filter(u => 
                u.id !== currentUser.id && 
                (u.username.toLowerCase().includes(query) || u.id.toLowerCase().includes(query))
            );

            const container = document.getElementById('searchResults');
            container.innerHTML = '';

            if (results.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
            } else {
                results.forEach(user => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-3 p-3 bg-gray-700 rounded-lg hover:bg-gray-600 cursor-pointer transition';
                    div.innerHTML = `
                        <img src="${user.avatar}" class="w-12 h-12 rounded-full object-cover">
                        <div>
                            <p class="text-white font-medium">${user.username}</p>
                            <p class="text-gray-400 text-sm">${user.id}</p>
                        </div>
                    `;
                    div.onclick = () => {
                        closeSearch();
                        openPrivateChat(user.id);
                    };
                    container.appendChild(div);
                });
            }

            document.getElementById('searchModal').classList.remove('hidden');
        }

        function closeSearch() {
            document.getElementById('searchModal').classList.add('hidden');
        }

        // Messages
        function getMessages() {
            return JSON.parse(localStorage.getItem('scam_messages') || '{}');
        }

        function saveMessages(messages) {
            localStorage.setItem('scam_messages', JSON.stringify(messages));
        }

        function getChatKey(userId1, userId2) {
            return [userId1, userId2].sort().join('_');
        }

        function loadChatList() {
            const messages = getMessages();
            const users = getUsers();
            const chatList = document.getElementById('chatList');
            chatList.innerHTML = '';

            const chats = new Set();
            Object.keys(messages).forEach(key => {
                if (key !== 'global' && key.includes(currentUser.id)) {
                    const otherUserId = key.split('_').find(id => id !== currentUser.id);
                    if (otherUserId && users[otherUserId]) {
                        chats.add(otherUserId);
                    }
                }
            });

            chats.forEach(userId => {
                const user = users[userId];
                if (user) {
                    const chatKey = getChatKey(currentUser.id, userId);
                    const chatMessages = messages[chatKey] || [];
                    const lastMessage = chatMessages[chatMessages.length - 1];

                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-3 p-4 hover:bg-gray-700 cursor-pointer transition border-b border-gray-700';
                    div.innerHTML = `
                        <img src="${user.avatar}" class="w-12 h-12 rounded-full object-cover">
                        <div class="flex-1 min-w-0">
                            <p class="text-white font-medium truncate">${user.username}</p>
                            <p class="text-gray-400 text-sm truncate">${lastMessage ? lastMessage.text : '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</p>
                        </div>
                    `;
                    div.onclick = () => openPrivateChat(userId);
                    chatList.appendChild(div);
                }
            });
        }

        function openGlobalChat() {
            isGlobalChat = true;
            currentChat = null;
            document.getElementById('noChatSelected').classList.add('hidden');
            document.getElementById('chatArea').classList.remove('hidden');
            document.getElementById('chatName').textContent = 'üåç –û–±—â–∏–π —á–∞—Ç';
            document.getElementById('chatAvatar').src = 'https://api.dicebear.com/7.x/identicon/svg?seed=global';
            document.getElementById('chatStatus').textContent = '–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏';
            loadMessages();
        }

        function openPrivateChat(userId) {
            const users = getUsers();
            const user = users[userId];
            if (!user) return;

            isGlobalChat = false;
            currentChat = userId;
            document.getElementById('noChatSelected').classList.add('hidden');
            document.getElementById('chatArea').classList.remove('hidden');
            document.getElementById('chatName').textContent = user.username;
            document.getElementById('chatAvatar').src = user.avatar;
            document.getElementById('chatStatus').textContent = '–í —Å–µ—Ç–∏';
            loadMessages();
            loadChatList();
        }

        function loadMessages() {
            const messages = getMessages();
            const users = getUsers();
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';

            let chatMessages = [];
            if (isGlobalChat) {
                chatMessages = messages['global'] || [];
            } else if (currentChat) {
                const chatKey = getChatKey(currentUser.id, currentChat);
                chatMessages = messages[chatKey] || [];
            }

            chatMessages.forEach(msg => {
                const isMine = msg.senderId === currentUser.id;
                const sender = users[msg.senderId] || { username: '–£–¥–∞–ª—ë–Ω–Ω—ã–π', avatar: '' };
                
                const div = document.createElement('div');
                div.className = `flex ${isMine ? 'justify-end' : 'justify-start'}`;
                
                const bubbleClass = isMine ? 'chat-bubble-sent' : 'chat-bubble-received';
                
                div.innerHTML = `
                    <div class="flex ${isMine ? 'flex-row-reverse' : ''} items-end gap-2 max-w-[70%]">
                        <img src="${sender.avatar}" class="w-8 h-8 rounded-full object-cover cursor-pointer" onclick="openPrivateChat('${msg.senderId}')">
                        <div class="${bubbleClass} px-4 py-2 rounded-2xl">
                            ${isGlobalChat || !isMine ? `<p class="text-indigo-300 text-xs font-medium mb-1 cursor-pointer" onclick="openPrivateChat('${msg.senderId}')">${sender.username}</p>` : ''}
                            <p class="text-white break-words">${msg.text}</p>
                            <p class="text-gray-300 text-xs mt-1 text-right">${new Date(msg.timestamp).toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</p>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });

            container.scrollTop = container.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text) return;

            const messages = getMessages();
            const message = {
                id: Date.now(),
                senderId: currentUser.id,
                text,
                timestamp: Date.now()
            };

            if (isGlobalChat) {
                if (!messages['global']) messages['global'] = [];
                messages['global'].push(message);
            } else if (currentChat) {
                const chatKey = getChatKey(currentUser.id, currentChat);
                if (!messages[chatKey]) messages[chatKey] = [];
                messages[chatKey].push(message);
            }

            saveMessages(messages);
            input.value = '';
            document.getElementById('emojiPicker').classList.remove('active');
            loadMessages();
            loadChatList();
        }

        function checkForUpdates() {
            if (isGlobalChat || currentChat) {
                loadMessages();
            }
            loadChatList();
            checkIncomingCalls();
        }

        // Calls
        function getCalls() {
            return JSON.parse(localStorage.getItem('scam_calls') || '{}');
        }

        function saveCalls(calls) {
            localStorage.setItem('scam_calls', JSON.stringify(calls));
        }

        async function startCall(isVideo) {
            if (!currentChat) return;

            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: isVideo,
                    audio: true
                });

                const calls = getCalls();
                calls[currentChat] = {
                    from: currentUser.id,
                    to: currentChat,
                    isVideo,
                    timestamp: Date.now(),
                    status: 'calling'
                };
                saveCalls(calls);

                document.getElementById('localVideo').srcObject = localStream;
                
                const users = getUsers();
                const partner = users[currentChat];
                document.getElementById('callPartnerName').textContent = partner.username;
                
                document.getElementById('callModal').classList.remove('hidden');
                startCallTimer();
                
                micEnabled = true;
                cameraEnabled = isVideo;
                updateCallButtons();

            } catch (err) {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ' + err.message);
            }
        }

        function checkIncomingCalls() {
            const calls = getCalls();
            const incomingCall = Object.values(calls).find(c => 
                c.to === currentUser.id && c.status === 'calling' && Date.now() - c.timestamp < 30000
            );

            if (incomingCall && !incomingCallData) {
                incomingCallData = incomingCall;
                const users = getUsers();
                const caller = users[incomingCall.from];
                
                document.getElementById('incomingCallerAvatar').src = caller.avatar;
                document.getElementById('incomingCallerName').textContent = caller.username;
                document.getElementById('incomingCallType').textContent = incomingCall.isVideo ? '–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫...' : '–ì–æ–ª–æ—Å–æ–≤–æ–π –∑–≤–æ–Ω–æ–∫...';
                document.getElementById('incomingCallModal').classList.remove('hidden');
                
                // Play sound
                try {
                    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2telegs5o+LYlFcAADCi49WPUAAOLaXm1otN');
                    audio.loop = true;
                    audio.play().catch(() => {});
                    window.callRingtone = audio;
                } catch(e) {}
            }
        }

        async function acceptCall() {
            if (!incomingCallData) return;

            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: incomingCallData.isVideo,
                    audio: true
                });

                document.getElementById('localVideo').srcObject = localStream;
                
                const users = getUsers();
                const partner = users[incomingCallData.from];
                document.getElementById('callPartnerName').textContent = partner.username;
                
                const calls = getCalls();
                if (calls[currentUser.id]) {
                    calls[currentUser.id].status = 'accepted';
                    saveCalls(calls);
                }

                document.getElementById('incomingCallModal').classList.add('hidden');
                document.getElementById('callModal').classList.remove('hidden');
                
                if (window.callRingtone) {
                    window.callRingtone.pause();
                    window.callRingtone = null;
                }
                
                startCallTimer();
                micEnabled = true;
                cameraEnabled = incomingCallData.isVideo;
                updateCallButtons();
                
                currentChat = incomingCallData.from;
                incomingCallData = null;

            } catch (err) {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ' + err.message);
                declineCall();
            }
        }

        function declineCall() {
            if (window.callRingtone) {
                window.callRingtone.pause();
                window.callRingtone = null;
            }
            
            const calls = getCalls();
            if (incomingCallData && calls[currentUser.id]) {
                calls[currentUser.id].status = 'declined';
                saveCalls(calls);
            }
            
            document.getElementById('incomingCallModal').classList.add('hidden');
            incomingCallData = null;
        }

        function startCallTimer() {
            callSeconds = 0;
            callTimer = setInterval(() => {
                callSeconds++;
                const mins = Math.floor(callSeconds / 60).toString().padStart(2, '0');
                const secs = (callSeconds % 60).toString().padStart(2, '0');
                document.getElementById('callDuration').textContent = `${mins}:${secs}`;
            }, 1000);
        }

        function endCall() {
            if (callTimer) clearInterval(callTimer);
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }
            
            const calls = getCalls();
            if (currentChat && calls[currentChat]) {
                delete calls[currentChat];
                saveCalls(calls);
            }
            
            document.getElementById('callModal').classList.add('hidden');
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('remoteVideo').srcObject = null;
        }

        function toggleMic() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    micEnabled = !micEnabled;
                    audioTrack.enabled = micEnabled;
                    updateCallButtons();
                }
            }
        }

        function toggleCamera() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    cameraEnabled = !cameraEnabled;
                    videoTrack.enabled = cameraEnabled;
                    updateCallButtons();
                }
            }
        }

        async function toggleScreen() {
            try {
                if (screenEnabled) {
                    if (screenStream) {
                        screenStream.getTracks().forEach(track => track.stop());
                        screenStream = null;
                    }
                    document.getElementById('localVideo').srcObject = localStream;
                    screenEnabled = false;
                } else {
                    screenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: true,
                        audio: true
                    });
                    document.getElementById('localVideo').srcObject = screenStream;
                    screenEnabled = true;
                    
                    screenStream.getVideoTracks()[0].onended = () => {
                        document.getElementById('localVideo').srcObject = localStream;
                        screenEnabled = false;
                        updateCallButtons();
                    };
                }
                updateCallButtons();
            } catch (err) {
                console.log('Screen share cancelled');
            }
        }

        function updateCallButtons() {
            document.getElementById('micBtn').className = `${micEnabled ? 'bg-gray-600 hover:bg-gray-700' : 'bg-red-600 hover:bg-red-700'} text-white p-4 rounded-full transition text-2xl`;
            document.getElementById('cameraBtn').className = `${cameraEnabled ? 'bg-gray-600 hover:bg-gray-700' : 'bg-red-600 hover:bg-red-700'} text-white p-4 rounded-full transition text-2xl`;
            document.getElementById('screenBtn').className = `${screenEnabled ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-600 hover:bg-gray-700'} text-white p-4 rounded-full transition text-2xl`;
        }

        // Close modals on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeProfile();
                closeSearch();
            }
        });
    </script>
</body>
</html>